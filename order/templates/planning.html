<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning des Tâches</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f4;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    {% include 'navbar.html' %}

  

    <div class="container mt-5">
        <h2 class="text-center">Planning des Tâches</h2>

        <!-- Bouton pour ouvrir le modal d'ajout -->
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#planningModal" onclick="openAddModal()">Ajouter une tâche</button>

        <!-- Tableau des plannings -->
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Shift</th>
                    <th>Employé</th>
                    <th>Produit Préparé</th>
                    <th>Commentaires</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for planning in plannings %}
                <tr>
                    <td>{{ planning.date }}</td>
                    <td>{{ planning.get_shift_display }}</td>
                    <td>{{ planning.employes_assignes.nom }}</td>
                    <td>{{ planning.produit_nom }}</td>
                    <td>{{ planning.commentaires }}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#planningModal" onclick="openUpdateModal('{{ planning.planning_id }}', '{{ planning.date }}', '{{ planning.shift }}', '{{ planning.employes_assignes_id }}', '{{ planning.produits_prepares_id }}', '{{ planning.commentaires }}')">Modifier</button>
                        <form method="post" action="" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="planning_id" value="{{ planning.planning_id }}">
                            <button type="submit" name="action" value="delete" class="btn btn-danger btn-sm">Supprimer</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Diagramme de Gantt -->
        <h2 class="text-center mt-5">Visualisation du Planning - Diagramme de Gantt</h2>
        <div>
            {{ gantt_chart_html|safe }}
        </div>
    </div>

    <!-- Modal d'ajout et de modification -->
    <div class="modal fade" id="planningModal" tabindex="-1" aria-labelledby="planningModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="planningModalLabel">Ajouter/Modifier une tâche</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="planning_id" id="planningId">

                        <div class="mb-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date" required>
                        </div>

                        <div class="mb-3">
                            <label for="shift" class="form-label">Shift</label>
                            <select class="form-select" id="shift" name="shift" required>
                                <option value="Matin">Matin</option>
                                <option value="Après-midi">Après-midi</option>
                                <option value="Nuit">Nuit</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="employes_assignes" class="form-label">Employé Assigné</label>
                            <select class="form-select" id="employesAssignes" name="employes_assignes" required>
                                {% for employe in employes %}
                                <option value="{{ employe.employe_id }}">{{ employe.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="produits_prepares" class="form-label">Produit Préparé</label>
                            <select class="form-select" id="produitsPrepares" name="produits_prepares" required>
                                {% for produit in produits %}
                                <option value="{{ produit.product_id }}">{{ produit }}</option>
                                {% endfor %}
                            </select>
                           
                            
                        </div>

                        <div class="mb-3">
                            <label for="commentaires" class="form-label">Commentaires</label>
                            <textarea class="form-control" id="commentaires" name="commentaires" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        <button type="submit" class="btn btn-primary" name="action" value="add">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    {% include 'footer.html' %}

    <script>
        function openAddModal() {
            document.getElementById('planningId').value = '';
            document.getElementById('date').value = '';
            document.getElementById('shift').value = 'Matin';
            document.getElementById('employesAssignes').selectedIndex = 0;
            document.getElementById('produitsPrepares').selectedIndex = 0;
            document.getElementById('commentaires').value = '';
            document.querySelector('button[name="action"]').value = 'add';
            document.getElementById('planningModalLabel').innerText = 'Ajouter une tâche';
        }

        function openUpdateModal(planningId, date, shift, employeId, produitId, commentaires) {
            document.getElementById('planningId').value = planningId;
            document.getElementById('date').value = date;
            document.getElementById('shift').value = shift;
            document.getElementById('employesAssignes').value = employeId;
            document.getElementById('produitsPrepares').value = produitId;
            document.getElementById('commentaires').value = commentaires;
            document.querySelector('button[name="action"]').value = 'update';
            document.getElementById('planningModalLabel').innerText = 'Modifier une tâche';
        }

        // Récupérer les données du diagramme de Gantt depuis la vue Django
        const ganttData = JSON.parse('{{ gantt_data_json|safe }}');

        // Préparer les données pour Plotly
        const data = ganttData.map(item => ({
            x: [item.Début, item.Fin],
            y: item.Employé,
            type: 'bar',
            orientation: 'h',
            name: item.Shift,
            hovertext: `Produit : ${item.Produit}<br>Shift : ${item.Shift}`,
            marker: { color: item.Shift === 'Matin' ? 'blue' : item.Shift === 'Après-midi' ? 'orange' : 'purple' }
        }));

        const layout = {
            title: 'Diagramme de Gantt',
            xaxis: { title: 'Date et Heure', type: 'date' },
            yaxis: { title: 'Employé', automargin: true },
            barmode: 'stack',
            showlegend: true
        };

        Plotly.newPlot('ganttChart', data, layout);
    </script>
</body>

</html>
